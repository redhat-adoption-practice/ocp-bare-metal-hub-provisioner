# This file expects to have an 'item' variable which is a dictionary items entry
# where the key is an SPP baseline name and the value is the source URL for that baseline

- name: Create temporary mountpoint for source iso
  ansible.builtin.tempfile:
    state: directory
    suffix: spp-iso-source
  register: source_mount_dir

- name: Create build directory for slim iso
  ansible.builtin.file:
    path: "{{ build_dir }}/{{ item.key}}-slim"
    state: directory

- name: Copy data from source ISO
  block:
    - name: mount source iso
      ansible.posix.mount:
        path: "{{ source_mount_dir.path }}"
        src: "/var/www/html/hpe-spp/{{ item.key }}/{{ item.key }}.iso"
        fstype: iso9660
        opts: loop
        state: mounted
        fstab: "{{ build_dir }}/tmp.fstab"
      become: true

    - name: get paths of pxe kernel and initrd from SPP iso
      ansible.builtin.find:
        paths: "{{ source_mount_dir.path }}/pxe"
        recurse: true
        patterns:
          - vmlinuz
          - initrd.img
      register: spp_pxe_files

    - name: create boot directory in target
      ansible.builtin.file:
        path: "{{ build_dir }}/{{ item.key}}-slim/boot/grub"
        state: directory

    - name: get path to initrd image
      ansible.builtin.set_fact:
        initrd_image_path={{ (spp_pxe_files.files | selectattr("path", "search", ".*initrd.*") | first).path }}

    - name: get initrd image information
      ansible.builtin.stat:
        path: "{{ initrd_image_path }}"
      register: initrd_image_info

    - name: get initrd image compression format
      ansible.builtin.set_fact:
        initrd_is_gzip={{ initrd_image_info.stat.mimetype | regex_search('gzip', ignorecase=True) is not none }}
        initrd_is_lzma={{ initrd_image_info.stat.mimetype | regex_search('lzma', ignorecase=True) is not none }}

    - name: Abort if initrd image format is not known
      fail:
        msg: The initrd image compression format is unknown
      when: not initrd_is_lzma and not initrd_is_gzip

    - name: add httpfs2-ssl to initrd
      block:
        - name: create temporary initrd root
          ansible.builtin.tempfile:
            suffix: initrd
            state: directory
          register: initrd_tmp
        - name: uncompress and extract initrd (lzma)
          ansible.builtin.shell:
            cmd: "xz -dc < {{ initrd_image_path }} | cpio -idmv"
            chdir: "{{ initrd_tmp.path }}"
          when: initrd_is_lzma
        - name: uncompress and extract initrd (gzip)
          ansible.builtin.shell:
            cmd: "zcat {{ initrd_image_path }} | cpio -idmv"
            chdir: "{{ initrd_tmp.path }}"
          when: initrd_is_gzip
        - name: copy httpfs2-ssl into temporary initrd root
          ansible.builtin.copy:
            src: "{{ playbook_dir }}/files/httpfs2-ssl"
            dest: "{{ initrd_tmp.path }}/sbin/"
            mode: 0755
        - name: create updated initrd image (lzma)
          ansible.builtin.shell:
            cmd: find . 2>/dev/null | cpio -o -c -R root:root | xz -9 --format=lzma > {{ build_dir }}/{{ item.key }}-slim/boot/initrd.img
            chdir: "{{ initrd_tmp.path }}"
          when: initrd_is_lzma
        - name: create updated initrd image (gzip)
          ansible.builtin.shell:
            cmd: find . | cpio -o -c -R root:root | gzip -9 > {{ build_dir }}/{{ item.key }}-slim/boot/initrd.img
            chdir: "{{ initrd_tmp.path }}"
          when: initrd_is_gzip

    - name: copy source pxe files to build directory
      ansible.builtin.copy:
        remote_src: true
        src: "{{ pxe_file.path }}"
        dest: "{{ build_dir }}/{{ item.key}}-slim/boot/"
        force: false
      loop_control:
        loop_var: pxe_file
      loop: "{{ spp_pxe_files.files }}"

    - name: Copy Red Hat Grub2 EFI binaries
      ansible.builtin.copy:
        remote_src: true
        src: "/boot/efi"
        dest: "{{ build_dir }}/{{ item.key}}-slim"

    - name: create boot/grub2 directory
      ansible.builtin.file:
        path: "{{ build_dir }}/{{ item.key}}-slim/boot/grub2"
        state: directory

    - name: render grub2 configuration
      ansible.builtin.template:
        src: "hpe-spp-grub2.j2"
        dest: "{{ build_dir }}/{{ item.key}}-slim/{{ grub_config_path }}/grub.cfg"
      loop_control:
        loop_var: grub_config_path
      loop:
        - "boot/grub"
        - "boot/grub2"

    - name: generate slim iso with grub2-mkrescue
      ansible.builtin.command:
        cmd: "/bin/grub2-mkrescue -o /var/www/html/hpe-spp/{{ item.key }}/slim-boot.iso {{ build_dir }}/{{ item.key}}-slim"
      become: true
  always:
    - name: unmount source iso
      ansible.posix.mount:
        path: "{{ source_mount_dir.path }}"
        src: "/var/www/html/hpe-spp/{{ item.key }}/{{ item.key }}.iso"
        fstype: iso9660
        opts: loop
        state: unmounted
        fstab: "{{ build_dir }}/tmp.fstab"
      become: true

    - name: remove tempoary mountpoint
      ansible.builtin.file:
        path: "{{ source_mount_dir.path }}"
        state: absent

    - name: remove build direcctory
      ansible.builtin.file:
        path: "{{ build_dir }}/{{ item.key}}-slim"
        state: absent

    - name: remove temporary fstab
      ansible.builtin.file:
        path: "{{ build_dir }}/tmp.fstab"
        state: absent

    - name: remove temporary initrd root
      ansible.builtin.file:
        path: "{{ initrd_tmp.path }}"
        state: absent
