- name: Build temp directory
  file:
    path: "{{ build_dir }}/fcct_fragment_read"
    state: directory

- name: Copy fragments to read directory
  copy:
    src: "{{ item }}"
    dest: "{{ build_dir }}/fcct_fragment_read/{{ ansible_loop.index }}.yml"
  loop: "{{ additional_ignition_fragments }}"
  loop_control:
    extended: yes

- name: Read FCCT Fragments into Ansible
  include_vars:
    dir: "{{ build_dir }}/fcct_fragment_read"
    name: additional_ignition

- name: Debug ignition
  debug:
   var: additional_ignition

- name: Remove temp directory
  file:
    path: "{{ build_dir }}/fcct_fragment_read"
    state: absent

- name: Render Combined FCCT Config
  template:
    src: fcct-wrapper.yaml.j2
    dest: "{{build_dir}}/{{cluster_name}}-combined-fcct.fcc"

- name: Generate Combined Ignition
  shell: |
    #!/bin/bash
    podman run -i --rm {{fcct_image}} --pretty --strict < {{build_dir}}/{{cluster_name}}-combined-fcct.fcc > {{build_dir}}/{{cluster_name}}-combined-ignition.ign

- name: Patch initrd with combined Ignition
  shell: |
    #!/bin/bash
    podman run -i --rm -v {{build_dir}}/{{cluster_name}}-combined-ignition.ign:/combined-ignition.ign:z {{coreos_installer_image}} pxe ignition wrap -i /combined-ignition.ign > {{build_dir}}/{{cluster_name}}-combined-initrd
    cp {{build_dir}}/{{cluster_name}}-combined-initrd /var/www/html/{{cluster_name}}/ignition.initrd
